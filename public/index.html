<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professional Inventory Scanner</title>
  
  <!-- Dynamsoft Barcode Reader -->
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@11.0.3000/dist/dbr.bundle.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fff;
      color: #111;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .status {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .status.success { background: #e0ffe0; color: #1a8e1a; }
    .status.error { background: #ffe0e0; color: #d22; }
    .status.scanning { background: #e0f0ff; color: #0056b3; }

    .product-image {
      max-width: 150px;
      max-height: 150px;
    }
    
    .inventory-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 15px;
      font-size: 0.8em;
    }
    .inventory-table th,
    .inventory-table td {
      border: 1px solid #ccc;
      padding: 4px 2px;
      text-align: center;
      word-break: break-word;
      overflow: hidden;
    }
    .inventory-table th:first-child,
    .inventory-table td:first-child {
      width: 15%;
      font-weight: bold;
    }
    .inventory-table th:not(:first-child):not(:last-child),
    .inventory-table td:not(:first-child):not(:last-child) {
      width: 18%;
    }
    .inventory-table th:last-child,
    .inventory-table td:last-child {
      width: 13%;
      font-weight: bold;
    }
    .inventory-table th {
      background-color: #f5f5f5;
      font-weight: bold;
      font-size: 0.75em;
    }

    @media (max-width: 768px) {
      .container { padding: 10px; margin: 0; }
      .inventory-table { font-size: 0.7em; }
      .inventory-table th, .inventory-table td { padding: 3px 1px; }
      .inventory-table th { font-size: 0.65em; }
      .product-image { max-width: 120px; max-height: 120px; }
      body { padding: 10px; }
      h1 { font-size: 1.3em; margin-bottom: 15px; }
    }

    .stock-zero { color: red; font-weight: bold; }
    .stock-low { color: orange; font-weight: bold; }
    .stock-medium { color: #888; font-weight: bold; }
    .stock-high { color: green; font-weight: bold; }

    .btn-success {
      background: #28a745; color: white;
      padding: 10px 15px; border: none;
      border-radius: 4px; cursor: pointer;
      margin-top: 10px; margin-right: 10px;
    }
    .btn-primary {
      background: #007bff; color: white;
      padding: 10px 15px; border: none;
      border-radius: 4px; cursor: pointer;
      margin-top: 10px; margin-right: 10px;
    }
    .price-block {
      font-size: 1.2em; margin: 0.5em 0;
    }
    .price-block s { margin-left: 8px; color: #999; }
    input[type="text"] {
      width: 100%; padding: 12px; font-size: 1.1em;
      border: 2px solid #ddd; border-radius: 5px;
      margin-bottom: 15px;
    }
    input[type="text"]:focus { border-color: #007bff; outline: none; }
    .professional-badge {
      background: linear-gradient(45deg, #007bff, #28a745);
      color: white; padding: 5px 10px; border-radius: 15px;
      font-size: 0.8em; display: inline-block; margin-left: 10px;
    }
    .product-link:hover { text-decoration: underline !important; }

    /* Matching products grid */
    .upsell-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .upsell-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    .upsell-card img {
      max-width: 140px;
      max-height: 140px;
      object-fit: cover;
      margin-bottom: 6px;
    }
    .upsell-title {
      font-size: 0.95em;
      font-weight: 600;
      margin: 4px 0;
    }
    .upsell-price {
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Yakira Bella Inventory</h1>

    <input id="barcodeInput" type="text" placeholder="Enter or scan barcode" />

    <div style="margin-bottom: 15px;">
      <button class="btn-success" onclick="lookupBarcode()">Manual Lookup</button>
      <button class="btn-primary" onclick="startDynamsoft()">Camera Scanner</button>
    </div>

    <!-- NEW dropdown to toggle view -->
    <div style="margin-bottom: 10px;">
      <label for="viewMode" style="margin-right:8px;font-weight:600;">View:</label>
      <select id="viewMode" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px;">
        <option value="inventory" selected>Inventory</option>
        <option value="matching">Matching</option>
      </select>
    </div>

    <div id="status" class="status scanning" style="display:none;"></div>
    <div id="product" style="margin-top: 20px; display: none;"></div>
  </div>

  <script>
    const BACKEND_URL = 'https://ybbc.onrender.com';
    const statusDiv = document.getElementById("status");
    const productDiv = document.getElementById("product");

    let viewMode = 'inventory';
    let lastProductData = null;

    document.getElementById('viewMode').addEventListener('change', (e) => {
      viewMode = e.target.value;
      if (lastProductData) displayProduct(lastProductData);
    });

    window.onload = () => document.getElementById("barcodeInput").focus();
    document.getElementById("barcodeInput").addEventListener("keydown", e => {
      if (e.key === "Enter") lookupBarcode();
    });

    function showStatus(message, type='scanning') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
    }
    function hideStatus() { statusDiv.style.display = 'none'; }

    async function lookupBarcode() {
      const barcode = document.getElementById("barcodeInput").value.trim();
      if (!barcode) return;

      showStatus("üîç Looking up " + barcode + "...", 'scanning');
      try {
        const res = await fetch(`${BACKEND_URL}/lookup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ barcode })
        });
        if (!res.ok) {
          const errorData = await res.json();
          showStatus("‚ùå " + (errorData.error || "Product not found"), 'error');
          return;
        }
        const data = await res.json();
        lastProductData = data;
        displayProduct(data);
        hideStatus();
        document.getElementById("barcodeInput").value = "";
        document.getElementById("barcodeInput").focus();
      } catch (err) {
        showStatus("‚ùå Network error", 'error');
        console.error(err);
      }
    }

    function getStockClass(q) {
      if (q === 0) return 'stock-zero';
      if (q <= 2) return 'stock-low';
      if (q <= 5) return 'stock-medium';
      return 'stock-high';
    }

    function displayProduct(data) {
      // --- Common header ---
      let priceHTML = '';
      if (data.variants?.length) {
        const lowestPrice = Math.min(...data.variants.map(v => parseFloat(v.price) || Infinity));
        const lowestCompareAt = Math.min(...data.variants.map(v => parseFloat(v.compareAtPrice) || Infinity));
        if (lowestCompareAt && lowestCompareAt > lowestPrice) {
          priceHTML = `<div class="price-block"><strong>$${lowestPrice.toFixed(2)}</strong> <s>$${lowestCompareAt.toFixed(2)}</s></div>`;
        } else {
          priceHTML = `<div class="price-block"><strong>$${lowestPrice.toFixed(2)}</strong></div>`;
        }
      }
      const headerHTML = `
        <div style="margin-bottom: 1em;">
          <img src="${data.image}" class="product-image" alt="Product image" style="float: right; margin-left: 15px;" />
          <a href="https://yakirabella.myshopify.com/admin/products/${extractProductId(data.productId)}" target="_blank" style="color: #007bff; text-decoration: none; font-size: 1.3em; font-weight: bold;">
            ${data.title}
          </a><br>
          ${priceHTML}
          <div style="clear: both;"></div>
        </div>
      `;

      // --- Inventory view ---
      let inventoryHTML = '';
      if (data.variants?.length) {
        const locations = ["Bogota", "Cedarhurst", "Teaneck Store", "Toms River"];
        let tableHTML = `
          <table class="inventory-table">
            <thead>
              <tr>
                <th>Size</th>
                ${locations.map(loc => `<th>${loc}</th>`).join('')}
                <th>Total</th>
              </tr>
            </thead><tbody>
        `;
        const locationTotals = {};
        locations.forEach(loc => locationTotals[loc] = 0);
        let grandTotal = 0;

        data.variants.forEach(row => {
          tableHTML += `<tr><td><strong>${row.size}</strong></td>`;
          locations.forEach(loc => {
            const qty = row.inventory.find(e => e.location === loc)?.quantity || 0;
            locationTotals[loc] += qty; grandTotal += qty;
            tableHTML += `<td class="${getStockClass(qty)}">${qty}</td>`;
          });
          tableHTML += `<td><strong>${row.inventory.reduce((s,e)=>s+e.quantity,0)}</strong></td></tr>`;
        });

        tableHTML += `<tr style="background:#f0f0f0;"><td><strong>TOTAL</strong></td>`;
        locations.forEach(loc => tableHTML += `<td><strong>${locationTotals[loc]}</strong></td>`);
        tableHTML += `<td><strong>${grandTotal}</strong></td></tr></tbody></table>`;
        inventoryHTML = tableHTML;
      }

      // --- Matching view ---
      let matchingHTML = '';
      if (Array.isArray(data.upsells) && data.upsells.length) {
        matchingHTML = `
          <div class="upsell-grid">
            ${data.upsells.map(p => `
              <div class="upsell-card">
                <img src="${p.image}" alt="${p.title}">
                <div class="upsell-title">
                  <a href="https://yakirabella.myshopify.com/admin/products/${extractProductId(p.id)}" target="_blank" style="color:#007bff;text-decoration:none;">
                    ${p.title}
                  </a>
                </div>
                <div class="upsell-price">${p.price ? `$${Number(p.price).toFixed(2)}` : ''}</div>
              </div>`).join('')}
          </div>
        `;
      } else {
        matchingHTML = `<div style="margin-top:8px;color:#666;">No matching products found.</div>`;
      }

      productDiv.innerHTML = headerHTML + (viewMode === 'matching' ? matchingHTML : inventoryHTML);
      productDiv.style.display = "block";
    }

    function extractProductId(productId) {
      if (productId?.includes('gid://shopify/Product/')) return productId.split('/').pop();
      return productId || '';
    }

async function startDynamsoft() {
  try {
    showStatus("‚ö° Starting professional scanner...", 'scanning');

    if (typeof Dynamsoft === 'undefined') {
      showStatus("‚ùå Dynamsoft not loaded. Check internet connection.", 'error');
      return;
    }

    const barcodeScanner = new Dynamsoft.BarcodeScanner({
      license: "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0MzEyNTE0LTEwNDQ2Nzg3NCIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjEwNDMxMjUxNCIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjE5MzI1NzIzNDd9",
      barcodeFormats: [ Dynamsoft.DBR.EnumBarcodeFormat.BF_ONED ] // üîí restrict to 1D only
    });

    // Debug license verification
    barcodeScanner.onLicenseVerificationCallback = function (isSuccess, error) {
      if (isSuccess) {
        console.log("‚úÖ License verified successfully (1D only)");
      } else {
        console.error("‚ùå License verification failed:", error.message || error);
      }
    };

    const result = await barcodeScanner.launch();
    if (result.barcodeResults?.length) {
      const barcode = result.barcodeResults[0].text;
      document.getElementById("barcodeInput").value = barcode;
      showStatus("‚ö° Professional scan: " + barcode, 'success');
      await lookupBarcode();
    } else {
      showStatus("üì± No barcode detected. Try again.", 'scanning');
      setTimeout(hideStatus, 3000);
    }
  } catch (error) {
    console.error('Dynamsoft error:', error);
    showStatus("‚ùå Scanner error: " + error.message, 'error');
  }
}

  </script>
</body>
</html>
