<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professional Inventory Scanner</title>

  <!-- Dynamsoft Barcode Reader -->
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@11.0.3000/dist/dbr.bundle.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fff; color: #111; }
    .container { max-width: 900px; margin: auto; }

    .status { padding: 10px; margin-bottom: 10px; border-radius: 5px; display:none; }
    .status.success { background: #e0ffe0; color: #1a8e1a; }
    .status.error   { background: #ffe0e0; color: #d22; }
    .status.scanning{ background: #e0f0ff; color: #0056b3; }

    .product-image { max-width: 150px; max-height: 150px; }

    .inventory-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 15px; font-size: 0.85em; }
    .inventory-table th, .inventory-table td { border: 1px solid #ccc; padding: 6px 4px; text-align: center; word-break: break-word; }
    .inventory-table th { background-color: #f5f5f5; font-weight: bold; font-size: 0.8em; }
    .inventory-table th:first-child, .inventory-table td:first-child { width: 15%; font-weight: bold; }

    .stock-zero { color: red; font-weight: bold; }
    .stock-low { color: orange; font-weight: bold; }
    .stock-medium { color: #888; font-weight: bold; }
    .stock-high { color: green; font-weight: bold; }

    .btn-success, .btn-primary {
      color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; margin-right: 10px;
    }
    .btn-success { background: #28a745; }
    .btn-primary { background: #007bff; }

    .price-block { font-size: 1.2em; margin: 0.5em 0; }
    .price-block s { margin-left: 8px; color: #999; }

    input[type="text"] {
      width: 100%; padding: 12px; font-size: 1.05em; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 12px;
    }
    input[type="text"]:focus { border-color: #007bff; outline: none; }

    .product-link:hover { text-decoration: underline !important; }

    /* Grid for Matching & Siblings */
    .upsell-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px; margin-top: 12px;
    }
    .upsell-card {
      border: 1px solid #ddd; border-radius: 10px; padding: 10px; text-align: center;
    }
    .upsell-card img {
      max-width: 140px; max-height: 140px; object-fit: cover; margin-bottom: 6px;
    }
    .upsell-title { font-size: 0.95em; font-weight: 600; margin: 4px 0; }
    .upsell-price { font-size: 0.9em; color: #333; }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { padding: 0; margin: 0; }
      .inventory-table { font-size: 0.78em; }
      .inventory-table th, .inventory-table td { padding: 4px 2px; }
      .product-image { max-width: 120px; max-height: 120px; }
      h1 { font-size: 1.25em; margin-bottom: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Yakira Bella Inventory</h1>

    <input id="barcodeInput" type="text" placeholder="Enter or scan barcode" />

    <div style="margin-bottom: 12px;">
      <button class="btn-success" onclick="lookupBarcode()">Manual Lookup</button>
      <button class="btn-primary" onclick="startDynamsoft()">Camera Scanner</button>
    </div>

    <!-- View toggle (hidden automatically in client mode) -->
    <div id="viewControls" style="margin-bottom: 10px;">
      <label for="viewMode" style="margin-right:8px;font-weight:600;">View:</label>
      <select id="viewMode" style="padding:8px 10px;border:1px solid #ccc;border-radius:6px;">
        <option value="inventory" selected>Inventory</option>
        <option value="matching">Matching</option>
        <option value="returns">Returns</option> <!-- NEW: returns view -->
        <option value="client">Client</option>
      </select>
    </div>

    <div id="status" class="status scanning"></div>
    <div id="product" style="margin-top: 18px; display: none;"></div>
  </div>

  <script>
    // ---- CONFIG ----
    const BACKEND_URL = 'https://ybbc.onrender.com'; // change if needed
    const DYNAMSOFT_LICENSE = "DLS2eyJoYW5kc2hha2VDb2RlIjoiMTA0MzEyNTE0LTEwNDQ2Nzg3NCIsIm1haW5TZXJ2ZXJVUkwiOiJodHRwczovL21kbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJvcmdhbml6YXRpb25JRCI6IjEwNDMxMjUxNCIsInN0YW5kYnlTZXJ2ZXJVUkwiOiJodHRwczovL3NkbHMuZHluYW1zb2Z0b25saW5lLmNvbS8iLCJjaGVja0NvZGUiOjE5MzI1NzIzNDd9";

    // ---- RETURN RULES (EDIT HERE TO CHANGE LOGIC) ----
    // This is where you configure "scraggler" rules.
    // Explanation:
    // - warehouseLocation: which location to treat as the warehouse
    // - threshold: if total warehouse inventory (after this return) <= threshold => SEND TO STORES
    // - addReturnedUnit: if true, we simulate "after return" by adding 1 to current quantity
    // - byProductType: overrides threshold per Shopify productType (optional)
    const RETURN_RULES = {
      default: {
        warehouseLocation: "Bogota",
        threshold: 3,
        compareAgainst: "total",   // "total" (sum of all sizes) or "variant"
        addReturnedUnit: true
      },
      byProductType: {
        // EXAMPLES ‚Äî adjust to match your Shopify productType names:
        // "Dress":   { threshold: 2 },
        // "Dresses": { threshold: 2 },
        // "Skirt":   { threshold: 4 },
        // "Skirts":  { threshold: 4 }
      }
    };

    // ---- STATE ----
    const statusDiv = document.getElementById("status");
    const productDiv = document.getElementById("product");
    const viewControls = document.getElementById("viewControls");
    const viewSelect = document.getElementById("viewMode");

    // Determine client mode from URL:
    // - ?mode=client  OR  pathname ends with /client
    const params = new URLSearchParams(location.search);
    const clientByQuery = (params.get('mode') || '').toLowerCase() === 'client';
    const clientByPath = location.pathname.replace(/\/+$/, '').endsWith('/client');
    const CLIENT_MODE = clientByQuery || clientByPath;

    let viewMode = CLIENT_MODE ? 'client' : 'inventory';
    let lastProductData = null;

    // Hide the selector in client mode and lock to client view
    if (CLIENT_MODE) {
      viewControls.style.display = 'none';
    } else {
      viewSelect.value = viewMode;
      viewSelect.addEventListener('change', (e) => {
        viewMode = e.target.value;
        if (lastProductData) displayProduct(lastProductData);
      });
    }

    window.onload = () => document.getElementById("barcodeInput").focus();
    document.getElementById("barcodeInput").addEventListener("keydown", e => {
      if (e.key === "Enter") lookupBarcode();
    });

    function showStatus(message, type='scanning') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
    }
    function hideStatus() { statusDiv.style.display = 'none'; }

    async function lookupBarcode() {
      const barcode = document.getElementById("barcodeInput").value.trim();
      if (!barcode) return;

      showStatus("üîç Looking up " + barcode + "...", 'scanning');
      try {
        const res = await fetch(`${BACKEND_URL}/lookup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ barcode })
        });
        if (!res.ok) {
          const errorData = await res.json().catch(()=>({}));
          showStatus("‚ùå " + (errorData.error || "Product not found"), 'error');
          return;
        }
        const data = await res.json();
        lastProductData = data;
        displayProduct(data);
        hideStatus();
        const input = document.getElementById("barcodeInput");
        input.value = "";
        input.focus();
      } catch (err) {
        console.error(err);
        showStatus("‚ùå Network error", 'error');
      }
    }

    function getStockClass(q) {
      if (q === 0) return 'stock-zero';
      if (q <= 2) return 'stock-low';
      if (q <= 5) return 'stock-medium';
      return 'stock-high';
    }

    function extractProductId(productId) {
      if (productId?.includes('gid://shopify/Product/')) return productId.split('/').pop();
      return productId || '';
    }

    function cardHTML(p, clientMode=false) {
      const pid = extractProductId(p.id);
      const img = p.image || 'https://via.placeholder.com/150';
      const price = p.price ? `$${Number(p.price).toFixed(2)}` : '';
      const link = clientMode
        ? `https://yakirabella.com/products/${p.handle}`
        : `https://yakirabella.myshopify.com/admin/products/${pid}`;
      return `
        <div class="upsell-card">
          <img src="${img}" alt="${p.title}">
          <div class="upsell-title">
            <a href="${link}" target="_blank" style="color:#007bff;text-decoration:none;">
              ${p.title}
            </a>
          </div>
          <div class="upsell-price">${price}</div>
        </div>
      `;
    }

    // ---- RETURN DECISION HELPERS ----
    function getReturnRule(productType) {
      const base = { ...RETURN_RULES.default };
      const overrides = (RETURN_RULES.byProductType && RETURN_RULES.byProductType[productType]) || {};
      return { ...base, ...overrides };
    }

    function computeReturnDecision(data) {
      if (!data || !Array.isArray(data.variants) || !data.variants.length) return null;

      const rule = getReturnRule(data.productType || "");
      const warehouseLocation = rule.warehouseLocation || "Bogota";

      // Find total warehouse inventory for this product
      let totalWarehouseQty = 0;
      data.variants.forEach(v => {
        const level = (v.inventory || []).find(e => e.location === warehouseLocation);
        totalWarehouseQty += level?.quantity || 0;
      });

      // Simulate "after this return arrives"
      if (rule.addReturnedUnit) {
        totalWarehouseQty += 1;
      }

      const sendToStores = totalWarehouseQty <= rule.threshold;

      return {
        action: sendToStores ? "SEND_TO_STORES" : "RESTOCK_TO_WAREHOUSE",
        location: warehouseLocation,
        threshold: rule.threshold,
        quantityAfterReturn: totalWarehouseQty,
        rule
      };
    }

    function displayProduct(data) {
      // Price block from variants (lowest)
      let priceHTML = '';
      if (Array.isArray(data.variants) && data.variants.length) {
        const prices = data.variants.map(v => parseFloat(v.price)).filter(n => !isNaN(n));
        const compares = data.variants.map(v => parseFloat(v.compareAtPrice)).filter(n => !isNaN(n) && isFinite(n));
        const lowestPrice = prices.length ? Math.min(...prices) : null;
        const lowestCompareAt = compares.length ? Math.min(...compares) : null;

        if (lowestPrice != null) {
          if (lowestCompareAt && lowestCompareAt > lowestPrice) {
            priceHTML = `<div class="price-block"><strong>$${lowestPrice.toFixed(2)}</strong> <s>$${lowestCompareAt.toFixed(2)}</s></div>`;
          } else {
            priceHTML = `<div class="price-block"><strong>$${lowestPrice.toFixed(2)}</strong></div>`;
          }
        }
      }

      // Header (image, title, price)
      const adminHeader = `
        <div style="margin-bottom: 1em;">
          <img src="${data.image}" class="product-image" alt="Product image" style="float: right; margin-left: 15px;" />
          <a href="https://yakirabella.myshopify.com/admin/products/${extractProductId(data.productId)}" target="_blank" style="color: #007bff; text-decoration: none; font-size: 1.3em; font-weight: bold;">
            ${data.title}
          </a><br>
          ${priceHTML}
          <div style="clear: both;"></div>
        </div>
      `;
      const clientHeader = `
        <div style="margin-bottom: 1em;">
          <img src="${data.image}" class="product-image" alt="Product image" style="float: right; margin-left: 15px;" />
          <div style="color: #111; font-size: 1.3em; font-weight: bold;">${data.title}</div>
          ${priceHTML}
          <div style="clear: both;"></div>
        </div>
      `;
      const headerHTML = CLIENT_MODE ? clientHeader : adminHeader;

      // ----- Inventory view -----
      let inventoryHTML = '';
      if (Array.isArray(data.variants) && data.variants.length) {
        const locations = ["Bogota", "Cedarhurst", "Teaneck Store", "Toms River"];
        let tableHTML = `
          <table class="inventory-table">
            <thead>
              <tr>
                <th>Size</th>
                ${locations.map(loc => `<th>${loc}</th>`).join('')}
                <th>Total</th>
              </tr>
            </thead><tbody>
        `;
        const locationTotals = Object.fromEntries(locations.map(l => [l, 0]));
        let grandTotal = 0;

        data.variants.forEach(row => {
          tableHTML += `<tr><td><strong>${row.size}</strong></td>`;
          let rowTotal = 0;
          locations.forEach(loc => {
            const qty = (row.inventory || []).find(e => e.location === loc)?.quantity || 0;
            locationTotals[loc] += qty; rowTotal += qty; grandTotal += qty;
            tableHTML += `<td class="${getStockClass(qty)}">${qty}</td>`;
          });
          tableHTML += `<td><strong>${rowTotal}</strong></td></tr>`;
        });

        tableHTML += `<tr style="background:#f0f0f0;"><td><strong>TOTAL</strong></td>`;
        locations.forEach(loc => tableHTML += `<td><strong>${locationTotals[loc]}</strong></td>`);
        tableHTML += `<td><strong>${grandTotal}</strong></td></tr></tbody></table>`;
        inventoryHTML = tableHTML;
      } else {
        inventoryHTML = `<div style="color:#666;">No inventory data.</div>`;
      }

      // ----- Matching view -----
      let matchingHTML = '';
      if (Array.isArray(data.upsells) && data.upsells.length) {
        matchingHTML = `<div class="upsell-grid">${data.upsells.map(p => cardHTML(p, CLIENT_MODE)).join('')}</div>`;
      } else {
        matchingHTML = `<div style="margin-top:8px;color:#666;">No matching products found.</div>`;
      }

      // ----- Siblings (other colors) -----
      let siblingsHTML = '';
      if (Array.isArray(data.siblings) && data.siblings.length) {
        siblingsHTML = `<div class="upsell-grid">${data.siblings.map(p => cardHTML(p, CLIENT_MODE)).join('')}</div>`;
      } else {
        siblingsHTML = `<div style="margin-top:8px;color:#666;">No other colors found.</div>`;
      }

      // ----- Client composite view -----
      const clientHTML = `
        <div style="margin: 8px 0 16px 0;">
          <div style="font-size:1.05em; font-weight:600; margin:8px 0;">Matching Items</div>
          ${matchingHTML}
        </div>
        <div style="margin: 16px 0;">
          <div style="font-size:1.05em; font-weight:600; margin:8px 0;">Other Colors</div>
          ${siblingsHTML}
        </div>
      `;

      // ----- Returns view (uses inventory + return rules) -----
      let returnsHTML = '';
      if (Array.isArray(data.variants) && data.variants.length) {
        const decision = computeReturnDecision(data);
        if (decision) {
          const isSendToStore = decision.action === "SEND_TO_STORES";
          const bannerColor = isSendToStore ? '#28a745' : '#007bff';
          const bannerBg = isSendToStore ? '#e6ffed' : '#e7f0ff';
          const bannerText = isSendToStore ? 'SEND TO STORES' : 'RESTOCK TO WAREHOUSE';

          const explanation = isSendToStore
            ? `Total ${decision.location} inventory after this return (${decision.quantityAfterReturn}) is at or below your threshold (${decision.threshold}).`
            : `Total ${decision.location} inventory after this return (${decision.quantityAfterReturn}) is above your threshold (${decision.threshold}).`;

          returnsHTML = `
            <div style="border-radius:8px;padding:12px 14px;margin-bottom:16px;background:${bannerBg};">
              <div style="font-weight:700;font-size:1.05em;margin-bottom:4px;">Return Decision</div>
              <div style="font-size:1.3em;font-weight:800;color:${bannerColor};margin-bottom:4px;">
                ${bannerText}
              </div>
              <div style="font-size:0.9em;color:#444;">${explanation}</div>
              <div style="font-size:0.85em;color:#666;margin-top:4px;">
                Rules: Warehouse = ${decision.location}, Threshold = ${decision.threshold}, Compare = ${decision.rule.compareAgainst}, Add returned unit = ${decision.rule.addReturnedUnit}.
              </div>
              ${data.productType ? `<div style="font-size:0.85em;color:#666;margin-top:2px;">Product type: ${data.productType}</div>` : ''}
            </div>
            ${inventoryHTML}
          `;
        } else {
          returnsHTML = `<div style="margin:8px 0;color:#666;">No inventory data to evaluate return decision.</div>`;
        }
      } else {
        returnsHTML = `<div style="margin:8px 0;color:#666;">No inventory data to evaluate return decision.</div>`;
      }

      // Choose which body to display
      let bodyHTML = inventoryHTML;
      if (viewMode === 'matching') bodyHTML = matchingHTML;
      if (viewMode === 'client')   bodyHTML = clientHTML;
      if (viewMode === 'returns')  bodyHTML = returnsHTML;

      productDiv.innerHTML = headerHTML + bodyHTML;
      productDiv.style.display = "block";
    }

    async function startDynamsoft() {
      try {
        showStatus("‚ö° Starting professional scanner...", 'scanning');

        if (typeof Dynamsoft === 'undefined') {
          showStatus("‚ùå Dynamsoft not loaded. Check internet connection.", 'error');
          return;
        }

        const barcodeScanner = new Dynamsoft.BarcodeScanner({
          license: DYNAMSOFT_LICENSE,
          barcodeFormats: [ Dynamsoft.DBR.EnumBarcodeFormat.BF_ONED ] // 1D only
        });

        // License debug ‚Äî shows exact reason if it fails
        barcodeScanner.onLicenseVerificationCallback = function (isSuccess, error) {
          if (isSuccess) {
            console.log("‚úÖ License verified successfully (1D only)");
          } else {
            console.error("‚ùå License verification failed:", (error && error.message) || error);
          }
        };

        const result = await barcodeScanner.launch();
        if (result.barcodeResults?.length) {
          const barcode = result.barcodeResults[0].text;
          document.getElementById("barcodeInput").value = barcode;
          showStatus("‚ö° Professional scan: " + barcode, 'success');
          await lookupBarcode();
        } else {
          showStatus("üì± No barcode detected. Try again.", 'scanning');
          setTimeout(hideStatus, 3000);
        }
      } catch (error) {
        console.error('Dynamsoft error:', error);
        showStatus("‚ùå Scanner error: " + error.message, 'error');
      }
    }
  </script>
</body>
</html>
